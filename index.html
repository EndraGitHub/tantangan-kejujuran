<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pernyataan Integritas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
        .card { background-color: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .btn-primary { background-color: #4f46e5; color: white; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #e5e7eb; color: #1f2937; transition: background-color 0.2s; }
        .btn-secondary:hover { background-color: #d1d5db; }
        .btn-danger { background-color: #ef4444; color: white; transition: background-color 0.2s; }
        .btn-danger:hover { background-color: #dc2626; }
        .quiz-option { cursor: pointer; transition: transform 0.1s; }
        .quiz-option:hover { transform: scale(1.02); }
        .quiz-selected { border-width: 3px; border-color: #4f46e5; background-color: #eef2ff; }
        .progress-bar-fill { transition: width 0.5s ease-in-out; }
    </style>
</head>
<body>
    <div id="loginOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex flex-col items-center justify-center z-50 p-4">
        <div class="card p-8 w-full max-w-lg text-center">
            <h2 class="text-3xl font-bold mb-6 text-gray-800">Sistem Pernyataan Kejujuran</h2>
            <p class="text-gray-600 mb-6">Aplikasi ini memerlukan login menggunakan akun Google Anda untuk mengidentifikasi dan menyimpan pernyataan integritas pribadi.</p>
            <button id="googleSignInButton" class="w-full py-3 px-4 rounded-xl font-semibold flex items-center justify-center btn-primary text-lg">
                <svg class="w-5 h-5 mr-3" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12.023 12.5a.5.5 0 0 1-.5-.5h-.002a.5.5 0 0 1 .5-.5h.002a.5.5 0 0 1 .5.5a.5.5 0 0 1-.5.5z"/>
                    <path fill-rule="evenodd" d="M15.36 12.435c0 1.25-.39 2.19-1.03 2.85c-.64.66-1.55 1.01-2.73 1.01c-.91 0-1.74-.3-2.5-.9c-.76-.6-1.28-1.42-1.56-2.48h1.27c.22.68.62 1.22 1.18 1.62c.57.4 1.22.6 1.95.6c.92 0 1.64-.32 2.16-.96c.52-.64.78-1.5.78-2.58c0-.98-.24-1.78-.72-2.38c-.48-.6-.88-.9-1.4-.9c-.66 0-1.16.22-1.5.66c-.34.44-.5.88-.5 1.32h-1.3c0-1.04.38-1.92 1.14-2.64c.76-.72 1.77-1.08 3.03-1.08c1.18 0 2.09.35 2.73 1.01c.64.66 1.03 1.6 1.03 2.85zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8s-3.59 8-8 8z"/>
                </svg>
                Masuk dengan Google
            </button>
        </div>
    </div>

    <div id="mainAppContainer" class="hidden min-h-screen p-4 md:p-8">
        <div class="max-w-4xl mx-auto">
            
            <!-- Header dan Pengguna -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 p-4 card bg-white/50 backdrop-blur-sm sticky top-0 z-10">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2 md:mb-0">Aplikasi Integritas Pegawai</h1>
                <div class="text-right flex flex-wrap items-center space-x-2 space-y-2 md:space-y-0 mt-2 md:mt-0">
                    <p id="welcomeMessage" class="text-sm font-medium text-gray-600 w-full md:w-auto"></p>
                    <button id="resetDataButton" class="text-xs font-medium text-red-600 hover:text-red-800 px-3 py-1 rounded-full border border-red-300 transition duration-150 btn-secondary">
                        Hapus & Reset Data Saya
                    </button>
                    <!-- TOMBOL ADMIN BARU -->
                    <button id="adminResetAllDataButton" class="text-xs font-medium px-3 py-1 rounded-full transition duration-150 btn-danger">
                        Admin: Hapus SELURUH Data Aplikasi
                    </button>
                    <!-- END TOMBOL ADMIN -->
                    <button id="signOutButton" class="text-sm font-semibold py-1 px-3 rounded-xl btn-secondary">Keluar</button>
                </div>
            </div>

            <!-- Area Notifikasi -->
            <div id="messageBox" class="mb-6 p-3 rounded-xl hidden text-sm font-medium" role="alert"></div>
            
            <!-- Langkah 1: Input Pernyataan -->
            <div id="step2" class="card p-6 mb-8 transition-opacity duration-300">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Langkah 1: Input Pernyataan Tentang Diri Anda</h2>
                <p class="text-gray-600 mb-4 text-sm">Berikan 3 (tiga) pernyataan yang BENAR tentang diri Anda, dan 1 (satu) pernyataan yang SALAH. Pastikan pernyataan salah tersebut sangat meyakinkan.</p>
                
                <div id="statementForm">
                    <h3 class="font-medium text-indigo-600 mb-2">3 Pernyataan Benar (Wajib)</h3>
                    <textarea id="true1" class="w-full p-3 mb-3 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500" rows="2" placeholder="Pernyataan Benar 1"></textarea>
                    <textarea id="true2" class="w-full p-3 mb-3 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500" rows="2" placeholder="Pernyataan Benar 2"></textarea>
                    <textarea id="true3" class="w-full p-3 mb-5 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500" rows="2" placeholder="Pernyataan Benar 3"></textarea>
                    
                    <h3 class="font-medium text-red-600 mb-2">1 Pernyataan Salah (Wajib)</h3>
                    <textarea id="false1" class="w-full p-3 mb-5 border rounded-lg focus:ring-red-500 focus:border-red-500" rows="2" placeholder="Pernyataan Salah (Ini adalah tes kejujuran Anda!)"></textarea>

                    <button id="submitButton" class="w-full py-3 rounded-xl font-semibold btn-primary">Simpan Data Pernyataan</button>
                </div>
            </div>

            <!-- Langkah 2: Monitoring Status Pengisian -->
            <div id="step3" class="card p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Langkah 2: Monitoring Status Pengisian</h2>
                <div id="monitoringTableContainer" class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status Pernyataan</th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu Submit</th>
                            </tr>
                        </thead>
                        <tbody id="monitoringTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Data Karyawan akan di-inject di sini -->
                            <tr><td colspan="4" class="text-center py-4 text-gray-500">Memuat data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Langkah 3: Tes Kejujuran (Kuis) -->
            <div id="step4" class="card p-6 mb-8 opacity-50 pointer-events-none transition-opacity duration-300">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Langkah 3: Tes Kejujuran (Kuis)</h2>
                
                <div id="quizProgress" class="mb-4">
                    <p class="text-sm font-medium text-gray-700 mb-1">Progres Kuis: <span id="quizProgressText">0/4</span></p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="quizProgressBar" class="bg-indigo-600 h-2.5 rounded-full progress-bar-fill" style="width: 0%"></div>
                    </div>
                </div>

                <div id="quizArea" class="space-y-6">
                    <!-- Soal Kuis akan di-inject di sini -->
                    <p class="text-gray-500 text-center py-8">Lengkapi Langkah 1 untuk memulai kuis.</p>
                </div>

                <button id="submitQuizButton" class="w-full py-3 rounded-xl font-semibold btn-primary mt-6 hidden">Kirim Jawaban Kuis</button>
                <div id="quizResult" class="mt-6 p-4 rounded-xl bg-green-100 text-green-800 font-semibold hidden"></div>
            </div>

            <!-- Langkah 4: Leaderboard -->
            <div id="step5" class="card p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Langkah 4: Leaderboard Nilai Kejujuran</h2>
                <div id="leaderboardContainer" class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Peringkat</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Skor Kuis</th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Skor Total (Simulasi)</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Data Leaderboard akan di-inject di sini -->
                            <tr><td colspan="4" class="text-center py-4 text-gray-500">Memuat data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- Modals dan Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            onSnapshot, 
            collection, 
            query, 
            getDocs, 
            deleteDoc,
            writeBatch // Import writeBatch untuk menghapus banyak dokumen
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // setLogLevel('Debug'); // Aktifkan untuk debugging

        // Global Variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, db, auth;
        let userId = null;
        let statementsData = [];
        let monitoringUnsubscribe = null;
        let quizUnsubscribe = null;
        let leaderboardUnsubscribe = null;
        
        // Path Collection Public
        const employeeCollectionPath = `artifacts/${appId}/public/data/employee_monitoring`;
        const leaderboardCollectionPath = `artifacts/${appId}/public/data/leaderboard`;

        // Utility Functions
        function showMessage(text, type = 'info') {
            const box = document.getElementById('messageBox');
            box.textContent = text;
            box.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800', 'bg-blue-100', 'text-blue-800');
            
            switch (type) {
                case 'success':
                    box.classList.add('bg-green-100', 'text-green-800');
                    break;
                case 'error':
                    box.classList.add('bg-red-100', 'text-red-800');
                    break;
                case 'info':
                default:
                    box.classList.add('bg-blue-100', 'text-blue-800');
                    break;
            }
            box.classList.remove('hidden');
        }

        function showLoading(isLoading, buttonId = 'submitButton') {
            const btn = document.getElementById(buttonId);
            if (!btn) return;
            
            if (isLoading) {
                btn.disabled = true;
                btn.dataset.originalText = btn.textContent;
                btn.innerHTML = `
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Memproses...
                `;
            } else {
                btn.disabled = false;
                btn.textContent = btn.dataset.originalText || 'Simpan Data Pernyataan';
            }
        }

        // --- FIREBASE INITIALIZATION & AUTH ---

        if (firebaseConfig) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            initializeFirebase();
        } else {
            console.error("Firebase config is missing.");
            document.getElementById('loginOverlay').innerHTML = '<p class="text-red-500">Kesalahan: Konfigurasi Firebase tidak tersedia.</p>';
        }

        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            try {
                // Tambahkan 'prompt: select_account' agar pengguna selalu bisa memilih akun
                provider.setCustomParameters({ prompt: 'select_account' });
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Error signing in with Google: ", error);
                showMessage("Gagal melakukan login Google.", 'error');
            }
        }
        
        async function initializeFirebase() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, async (user) => {
                    const loginOverlay = document.getElementById('loginOverlay');
                    const mainAppContainer = document.getElementById('mainAppContainer');
                    const googleSignInButton = document.getElementById('googleSignInButton');

                    if (user && user.isAnonymous) {
                        // --- PENGGUNA ANONIM ---
                        loginOverlay.classList.remove('hidden');
                        mainAppContainer.classList.add('hidden');
                        googleSignInButton.addEventListener('click', handleGoogleSignIn);
                        showMessage("Anda harus login Google untuk menggunakan fitur ini.", 'info');
                    } else if (user) {
                        // --- PENGGUNA LOGIN ---
                        userId = user.uid;
                        
                        document.getElementById('welcomeMessage').textContent = `Login sebagai: ${user.displayName} (${user.email})`;
                        
                        loginOverlay.classList.add('hidden');
                        mainAppContainer.classList.remove('hidden');
                        
                        showMessage(`Login Berhasil! Selamat datang, ${user.displayName}.`, 'success');
                        
                        // PERBAIKAN: Langsung aktifkan form input (Langkah 1) setelah login berhasil
                        document.getElementById('step2').classList.remove('opacity-50', 'pointer-events-none');
                        
                        setupMonitoring();
                        setupLeaderboard();
                        
                        checkUserSubmissionStatus();
                        setupQuizProgressMonitoring(); 

                    } else {
                        // Jika tidak ada user (setelah sign out), kembali ke layar login
                        loginOverlay.classList.remove('hidden');
                        mainAppContainer.classList.add('hidden');
                        resetUIOnLogout();
                    }
                });

            } catch (error) {
                console.error("Error during initial auth or setup: ", error);
                showMessage("Kesalahan saat otentikasi awal.", 'error');
            }
        }
        
        function resetUIOnLogout() {
            document.getElementById('welcomeMessage').textContent = 'Belum Login';
            document.getElementById('messageBox').classList.add('hidden');
            
            // Reset Langkah 1
            document.querySelectorAll('#step2 textarea').forEach(ta => { ta.value = ''; ta.disabled = false; });
            document.getElementById('submitButton').disabled = false;
            document.getElementById('submitButton').textContent = 'Simpan Data Pernyataan';
            document.getElementById('step2').classList.remove('opacity-50', 'pointer-events-none'); // Selalu aktifkan setelah reset

            // Nonaktifkan Langkah 3 (Kuis)
            document.getElementById('step4').classList.add('opacity-50', 'pointer-events-none');
            // Reset state kuis
            document.getElementById('quizProgressText').textContent = '0/4';
            document.getElementById('quizProgressBar').style.width = '0%';
            document.getElementById('quizArea').innerHTML = '<p class="text-gray-500 text-center py-8">Lengkapi Langkah 1 untuk memulai kuis.</p>';
            document.getElementById('submitQuizButton').classList.add('hidden');
            document.getElementById('quizResult').classList.add('hidden');

            // Hentikan listener
            if (monitoringUnsubscribe) monitoringUnsubscribe();
            if (quizUnsubscribe) quizUnsubscribe();
            if (leaderboardUnsubscribe) leaderboardUnsubscribe();
            monitoringUnsubscribe = null;
            quizUnsubscribe = null;
            leaderboardUnsubscribe = null;
        }

        document.getElementById('signOutButton').addEventListener('click', async () => {
            try {
                await signOut(auth);
                showMessage("Anda telah berhasil keluar.", 'info');
            } catch (error) {
                console.error("Error signing out: ", error);
                showMessage("Gagal keluar.", 'error');
            }
        });

        // --- CORE APPLICATION LOGIC ---

        // Step 1: Submit Statements
        document.getElementById('submitButton').addEventListener('click', async () => {
            if (!userId) {
                showMessage("Anda harus login Google untuk menyimpan data.", 'error');
                return;
            }

            const true1 = document.getElementById('true1').value.trim();
            const true2 = document.getElementById('true2').value.trim();
            const true3 = document.getElementById('true3').value.trim();
            const false1 = document.getElementById('false1').value.trim();

            if (!true1 || !true2 || !true3 || !false1) {
                showMessage("Semua 4 pernyataan wajib diisi.", 'error');
                return;
            }

            const statements = [
                { text: true1, status: 'Benar' },
                { text: true2, status: 'Benar' },
                { text: true3, status: 'Benar' },
                { text: false1, status: 'Salah' }
            ];

            // Acak pernyataan untuk Kuis
            statementsData = statements.sort(() => Math.random() - 0.5);

            showLoading(true);

            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/submissions`, userId);

                // PERBAIKAN: Tambahkan fallback untuk displayName dan email
                const submissionData = {
                    googleName: auth.currentUser.displayName || 'Pengguna Tanpa Nama',
                    googleEmail: auth.currentUser.email || 'email-tidak-diketahui',
                    statements: statementsData,
                    submittedAt: new Date()
                };

                await setDoc(docRef, submissionData);
                
                // Tambahkan/Update data ke tabel monitoring publik
                const employeeDocRef = doc(db, employeeCollectionPath, userId);
                await setDoc(employeeDocRef, {
                    userId: userId,
                    name: auth.currentUser.displayName || 'Pengguna Tanpa Nama',
                    email: auth.currentUser.email || 'email-tidak-diketahui',
                    hasSubmitted: true,
                    submissionTime: new Date()
                }, { merge: true });


                showMessage("Pernyataan Anda berhasil disimpan!", "success");
                document.getElementById('submitButton').disabled = true;
                document.querySelectorAll('#step2 textarea').forEach(ta => ta.disabled = true);
                
                unlockQuizSection();
                
                // PERBAIKAN BARU: Scroll ke Langkah 2 (Monitoring) untuk feedback visual
                document.getElementById('step3').scrollIntoView({ behavior: 'smooth', block: 'start' });

            } catch (error) {
                console.error("Error submitting statements: ", error);
                showMessage(`Gagal menyimpan pernyataan: ${error.message}`, 'error');
            } finally {
                showLoading(false); // Pastikan loading berhenti
            }
        });

        async function checkUserSubmissionStatus() {
            if (!userId || !db) return;
            
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/submissions`, userId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const textareas = document.querySelectorAll('#step2 textarea');
                    statementsData = data.statements; // Muat pernyataan yang sudah tersimpan
                    
                    const trueStatements = data.statements.filter(s => s.status === 'Benar');
                    const falseStatement = data.statements.find(s => s.status === 'Salah');
                    
                    textareas[0].value = trueStatements[0]?.text || '';
                    textareas[1].value = trueStatements[1]?.text || '';
                    textareas[2].value = trueStatements[2]?.text || '';
                    textareas[3].value = falseStatement?.text || '';

                    document.querySelectorAll('#step2 textarea').forEach(ta => ta.disabled = true);
                    document.getElementById('submitButton').disabled = true;
                    document.getElementById('submitButton').textContent = 'Data Sudah Tersimpan';
                    showMessage("Anda sudah mengisi pernyataan. Anda dapat memulai kuis.", 'info');
                    
                    unlockQuizSection();
                } else {
                    // User baru, pastikan form diaktifkan dan kosong (sudah dilakukan di onAuthStateChanged)
                    document.querySelectorAll('#step2 textarea').forEach(ta => { ta.value = ''; ta.disabled = false; });
                    document.getElementById('submitButton').disabled = false;
                    document.getElementById('submitButton').textContent = 'Simpan Data Pernyataan';
                }

            } catch (error) {
                 console.error("Error checking submission status: ", error);
            }
        }

        function unlockQuizSection() {
            document.getElementById('step4').classList.remove('opacity-50', 'pointer-events-none');
            if (statementsData && statementsData.length > 0) {
                renderQuiz(statementsData);
            }
        }

        // --- Step 2: Monitoring (Public Data) ---
        function setupMonitoring() {
            if (monitoringUnsubscribe) monitoringUnsubscribe();
            
            // Dapatkan path koleksi employee_monitoring
            const monitoringRef = collection(db, employeeCollectionPath);
            const q = query(monitoringRef);

            monitoringUnsubscribe = onSnapshot(q, (snapshot) => {
                const tableBody = document.getElementById('monitoringTableBody');
                tableBody.innerHTML = ''; // Kosongkan tabel
                
                if (snapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Belum ada data pernyataan yang disimpan.</td></tr>';
                    return;
                }

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    const row = document.createElement('tr');
                    // Tambahkan class khusus jika baris ini adalah user yang sedang login
                    if (data.userId === userId) {
                         row.classList.add('bg-indigo-50', 'font-semibold');
                    } else {
                         row.classList.add('hover:bg-gray-50', 'transition', 'duration-150');
                    }

                    const submissionDate = data.submissionTime?.toDate ? data.submissionTime.toDate().toLocaleString('id-ID') : 'N/A';
                    const statusText = data.hasSubmitted ? 
                        `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Sudah Isi</span>` :
                        `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Belum Isi</span>`;

                    row.innerHTML = `
                        <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${data.name || 'N/A'}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${data.email || 'N/A'}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-center">${statusText}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500 text-center">${submissionDate}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }, (error) => {
                console.error("Error listening to monitoring data: ", error);
                document.getElementById('monitoringTableBody').innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500">Gagal memuat data monitoring.</td></tr>';
            });
        }
        
        // --- Langkah 3: Tes Kejujuran (Kuis) ---
        let currentQuiz = [];
        let userAnswers = {};

        function renderQuiz(statements) {
            currentQuiz = statements;
            userAnswers = {};
            
            const quizArea = document.getElementById('quizArea');
            quizArea.innerHTML = '';
            
            currentQuiz.forEach((statement, index) => {
                const quizItem = document.createElement('div');
                quizItem.className = 'card p-4 border border-gray-200 rounded-xl';
                quizItem.innerHTML = `
                    <p class="font-semibold mb-3 text-gray-800">Pernyataan ${index + 1}:</p>
                    <p class="text-gray-700 mb-4 italic">"${statement.text}"</p>
                    <div class="flex space-x-4">
                        <button data-index="${index}" data-answer="Benar" class="quiz-option flex-1 py-2 rounded-xl border border-green-400 text-green-700 bg-green-50 text-sm font-medium hover:bg-green-100">
                            Benar (True)
                        </button>
                        <button data-index="${index}" data-answer="Salah" class="quiz-option flex-1 py-2 rounded-xl border border-red-400 text-red-700 bg-red-50 text-sm font-medium hover:bg-red-100">
                            Salah (False)
                        </button>
                    </div>
                `;
                quizArea.appendChild(quizItem);
            });

            document.getElementById('submitQuizButton').classList.remove('hidden');
            document.getElementById('quizResult').classList.add('hidden');
            
            // Tambahkan event listener untuk pilihan kuis
            quizArea.querySelectorAll('.quiz-option').forEach(button => {
                button.addEventListener('click', handleQuizAnswer);
            });
            
            updateQuizProgressDisplay();
        }
        
        function handleQuizAnswer(event) {
            const button = event.target;
            const index = parseInt(button.dataset.index);
            const answer = button.dataset.answer; // 'Benar' atau 'Salah'
            
            userAnswers[index] = answer;
            
            // Hapus seleksi sebelumnya
            button.closest('div').querySelectorAll('.quiz-option').forEach(btn => {
                btn.classList.remove('quiz-selected');
                btn.classList.remove('bg-indigo-100');
                // Tambahkan kembali warna default agar tidak terlihat polos
                const isGreen = btn.dataset.answer === 'Benar';
                btn.classList.add(isGreen ? 'bg-green-50' : 'bg-red-50'); 
            });

            // Tandai seleksi baru
            button.classList.add('quiz-selected', 'bg-indigo-100'); 
            button.classList.remove('bg-green-50', 'bg-red-50'); // Hapus warna default
            
            updateQuizProgressDisplay();
        }
        
        function updateQuizProgressDisplay() {
            const answeredCount = Object.keys(userAnswers).length;
            const totalCount = currentQuiz.length;
            
            document.getElementById('quizProgressText').textContent = `${answeredCount}/${totalCount}`;
            const percentage = (answeredCount / totalCount) * 100;
            document.getElementById('quizProgressBar').style.width = `${percentage}%`;
            
            if (answeredCount === totalCount) {
                document.getElementById('submitQuizButton').disabled = false;
            } else {
                document.getElementById('submitQuizButton').disabled = true;
            }
        }
        
        document.getElementById('submitQuizButton').addEventListener('click', async () => {
            if (Object.keys(userAnswers).length !== currentQuiz.length) {
                showMessage("Anda harus menjawab semua pernyataan sebelum mengirim.", 'error');
                return;
            }

            // Hitung Skor
            let correctCount = 0;
            const totalQuestions = currentQuiz.length;
            
            currentQuiz.forEach((statement, index) => {
                // Jawaban Kuis (Persepsi Penilai)
                const userAnswer = userAnswers[index]; // 'Benar' atau 'Salah'
                
                // Status Sebenarnya (Isi Langkah 1)
                const actualStatus = statement.status; // 'Benar' atau 'Salah'
                
                // Jika persepsi penilai SAMA dengan status sebenarnya (berhasil mendeteksi)
                if (userAnswer === actualStatus) {
                    correctCount++;
                }
            });
            
            const totalScore = (correctCount / totalQuestions) * 100; // Normalisasi ke 100
            
            try {
                // 1. Simpan hasil kuis ke database pribadi
                const quizResultRef = doc(db, `artifacts/${appId}/users/${userId}/quiz_results`, userId);
                await setDoc(quizResultRef, {
                    score: totalScore,
                    correctAnswers: correctCount,
                    totalQuestions: totalQuestions,
                    quizSubmittedAt: new Date()
                });
                
                // 2. Update Leaderboard (Public)
                const leaderboardDocRef = doc(db, leaderboardCollectionPath, userId);
                await setDoc(leaderboardDocRef, {
                    userId: userId,
                    name: auth.currentUser.displayName || 'Pengguna Tanpa Nama',
                    email: auth.currentUser.email || 'email-tidak-diketahui',
                    quizScore: totalScore,
                    lastUpdated: new Date()
                }, { merge: true });
                
                // Tampilkan Hasil
                const resultBox = document.getElementById('quizResult');
                resultBox.classList.remove('hidden', 'bg-red-100', 'text-red-800');
                resultBox.classList.add('bg-green-100', 'text-green-800');
                resultBox.innerHTML = `Selamat! Anda berhasil menyelesaikan kuis. Skor Anda: <strong>${correctCount}/${totalQuestions} (${totalScore.toFixed(2)}%)</strong>.`;

                // Nonaktifkan kuis setelah submit
                document.getElementById('quizArea').querySelectorAll('.quiz-option').forEach(btn => btn.disabled = true);
                document.getElementById('submitQuizButton').disabled = true;

                showMessage("Skor kuis berhasil disimpan dan Leaderboard telah diperbarui!", 'success');
            } catch (error) {
                console.error("Error submitting quiz: ", error);
                showMessage(`Gagal menyimpan hasil kuis: ${error.message}`, 'error');
            }
        });

        function setupQuizProgressMonitoring() {
            if (quizUnsubscribe) quizUnsubscribe();

            const quizResultRef = doc(db, `artifacts/${appId}/users/${userId}/quiz_results`, userId);

            quizUnsubscribe = onSnapshot(quizResultRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const correctCount = data.correctAnswers || 0;
                    const totalCount = data.totalQuestions || 4; 
                    const totalScore = data.score || 0;
                    
                    const resultBox = document.getElementById('quizResult');
                    resultBox.classList.remove('hidden', 'bg-red-100', 'text-red-800');
                    resultBox.classList.add('bg-green-100', 'text-green-800');
                    resultBox.innerHTML = `Hasil Kuis Tersimpan: <strong>${correctCount}/${totalCount} (${totalScore.toFixed(2)}%)</strong>.`;

                    document.getElementById('submitQuizButton').disabled = true;
                    document.getElementById('submitQuizButton').classList.add('hidden'); // Sembunyikan tombol submit kuis

                    // Kunci UI kuis
                    document.getElementById('quizArea').querySelectorAll('.quiz-option').forEach(btn => btn.disabled = true);
                    
                } else {
                    document.getElementById('quizResult').classList.add('hidden');
                    document.getElementById('submitQuizButton').classList.remove('hidden');
                    document.getElementById('submitQuizButton').disabled = false;
                    document.getElementById('quizArea').querySelectorAll('.quiz-option').forEach(btn => btn.disabled = false);
                }
            }, (error) => {
                console.error("Error monitoring quiz progress: ", error);
            });
        }


        // --- Langkah 4: Leaderboard ---
        function setupLeaderboard() {
            if (leaderboardUnsubscribe) leaderboardUnsubscribe();
            
            const leaderboardRef = collection(db, leaderboardCollectionPath);
            // Sorting di-memory karena Firestore orderBy() memerlukan indeks
            const q = query(leaderboardRef); 

            leaderboardUnsubscribe = onSnapshot(q, (snapshot) => {
                const tableBody = document.getElementById('leaderboardTableBody');
                tableBody.innerHTML = '';
                
                if (snapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Belum ada skor kuis yang tercatat.</td></tr>';
                    return;
                }

                let leaderboardData = [];
                snapshot.forEach(doc => {
                    leaderboardData.push(doc.data());
                });

                // Sortir data di client side (Skor tertinggi ke terendah)
                leaderboardData.sort((a, b) => (b.quizScore || 0) - (a.quizScore || 0));

                leaderboardData.forEach((data, index) => {
                    const row = document.createElement('tr');
                    
                    const isCurrentUser = data.userId === userId;
                    if (isCurrentUser) {
                         row.classList.add('bg-indigo-50', 'font-semibold', 'border-2', 'border-indigo-200');
                    } else {
                         row.classList.add('hover:bg-gray-50', 'transition', 'duration-150');
                    }

                    const rankClass = index === 0 ? 'bg-yellow-100 text-yellow-800 font-bold' : 
                                      index === 1 ? 'bg-gray-100 text-gray-800 font-semibold' :
                                      index === 2 ? 'bg-amber-100 text-amber-800 font-semibold' : '';

                    row.innerHTML = `
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-center ${rankClass}">#${index + 1}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${data.name || 'N/A'}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-700 text-center">${(data.quizScore || 0).toFixed(2)}%</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500 text-center">${((data.quizScore || 0) * 1.5).toFixed(2)}%</td>
                    `;
                    tableBody.appendChild(row);
                });
            }, (error) => {
                console.error("Error listening to leaderboard data: ", error);
                document.getElementById('leaderboardTableBody').innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500">Gagal memuat Leaderboard.</td></tr>';
            });
        }
        
        // --- FITUR: RESET DATA PENGGUNA INDIVIDUAL ---
        document.getElementById('resetDataButton').addEventListener('click', async () => {
            if (!userId) {
                showMessage("Anda harus login Google untuk menghapus data Anda.", 'error');
                return;
            }
            
            if (!confirm("APAKAH ANDA YAKIN INGIN MENGHAPUS SEMUA DATA PRIBADI ANDA? Ini termasuk Pernyataan, Hasil Kuis, dan entri Leaderboard. Tindakan ini tidak dapat dibatalkan.")) {
                 return;
            }

            try {
                // 1. Hapus dokumen Pernyataan Pribadi
                const statementDocRef = doc(db, `artifacts/${appId}/users/${userId}/submissions`, userId);
                await deleteDoc(statementDocRef);
                
                // 2. Hapus dokumen Hasil Kuis Pribadi
                const quizResultDocRef = doc(db, `artifacts/${appId}/users/${userId}/quiz_results`, userId);
                await deleteDoc(quizResultDocRef);

                // 3. Hapus dokumen dari Leaderboard Publik
                const leaderboardDocRef = doc(db, leaderboardCollectionPath, userId);
                await deleteDoc(leaderboardDocRef);
                
                // 4. Hapus dokumen dari Monitoring Publik
                const employeeDocRef = doc(db, employeeCollectionPath, userId);
                // Hanya set 'hasSubmitted' ke false, atau hapus jika ingin total reset
                // Kali ini kita hapus total untuk simulasi reset penuh
                await deleteDoc(employeeDocRef);


                // 5. Reset UI ke kondisi awal (setelah login)
                statementsData = []; // Kosongkan data pernyataan
                userAnswers = {}; // Kosongkan jawaban kuis
                resetUIOnLogout(); // Reset semua listener dan tampilan
                
                // Aktifkan kembali Langkah 1
                document.getElementById('step2').classList.remove('opacity-50', 'pointer-events-none');
                
                // Inisiasi ulang monitoring dan leaderboard
                setupMonitoring();
                setupLeaderboard();
                
                showMessage("Data Anda (Pernyataan, Kuis, Leaderboard) berhasil dihapus dan direset. Silakan isi kembali Langkah 1.", 'success');
                
            } catch (error) {
                console.error("Error deleting user data: ", error);
                showMessage(`Gagal menghapus data: ${error.message}. Coba lagi.`, 'error');
            }
        });

        // --- FITUR BARU: ADMIN HAPUS SEMUA DATA ---
        document.getElementById('adminResetAllDataButton').addEventListener('click', async () => {
            if (!userId) {
                showMessage("Admin Reset gagal. Anda harus login Google.", 'error');
                return;
            }

            if (!confirm("PERINGATAN ADMIN! Tindakan ini akan menghapus SEMUA data pernyataan dan kuis dari SELURUH pengguna di aplikasi ini. Lanjutkan? Ketik 'HAPUS SEMUA' untuk konfirmasi.")) {
                 return;
            }
            
            // Konfirmasi kedua
            if (window.prompt("KONFIRMASI AKHIR. Ketik kata 'HAPUS SEMUA' untuk melanjutkan.") !== 'HAPUS SEMUA') {
                showMessage("Penghapusan seluruh data dibatalkan.", 'info');
                return;
            }


            showLoading(true, 'adminResetAllDataButton');
            showMessage("Memulai proses penghapusan data SELURUH pengguna. Mohon tunggu...", 'error');

            try {
                // 1. Ambil semua User ID dari koleksi Monitoring (sumber data semua pengguna aktif)
                const employeeSnapshot = await getDocs(collection(db, employeeCollectionPath));
                const userIds = employeeSnapshot.docs.map(doc => doc.id);

                const batch = writeBatch(db);
                let deletedCount = 0;

                for (const uid of userIds) {
                    // Hapus data pribadi (Submissions)
                    const statementDocRef = doc(db, `artifacts/${appId}/users/${uid}/submissions`, uid);
                    batch.delete(statementDocRef);
                    
                    // Hapus data pribadi (Quiz Results)
                    const quizResultDocRef = doc(db, `artifacts/${appId}/users/${uid}/quiz_results`, uid);
                    batch.delete(quizResultDocRef);
                    
                    // Hapus data publik (Monitoring)
                    const employeeDocRef = doc(db, employeeCollectionPath, uid);
                    batch.delete(employeeDocRef);
                    
                    // Hapus data publik (Leaderboard)
                    const leaderboardDocRef = doc(db, leaderboardCollectionPath, uid);
                    batch.delete(leaderboardDocRef);

                    deletedCount++;
                }

                // Jalankan batch delete
                await batch.commit();

                // 2. Reset UI pengguna saat ini
                resetUIOnLogout();
                document.getElementById('step2').classList.remove('opacity-50', 'pointer-events-none');
                
                // 3. Inisiasi ulang monitoring dan leaderboard
                setupMonitoring();
                setupLeaderboard();

                showMessage(`Admin: Berhasil menghapus semua data (${deletedCount} pengguna) dari aplikasi. Aplikasi direset total.`, 'success');
                
            } catch (error) {
                console.error("Error during admin reset: ", error);
                showMessage(`Admin: Gagal menghapus seluruh data. Error: ${error.message}`, 'error');
            } finally {
                showLoading(false, 'adminResetAllDataButton');
            }
        });
        
        // Ganti alert() dengan konfirmasi khusus untuk lingkungan ini
        function confirm(message) {
            // Menggunakan window.prompt untuk simulasi konfirmasi dalam lingkungan iframe
            console.warn("Menggunakan simulasi konfirmasi. Di aplikasi nyata, gunakan modal custom.");
            return window.prompt(message + "\n\nKetik 'YA' untuk melanjutkan.") === 'YA';
        }

    </script>
</body>
</html>
